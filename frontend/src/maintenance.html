<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Maintenance Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <style>
    .modal { transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
    .modal.hidden { visibility: hidden; opacity: 0; }
    .modal:not(.hidden) { visibility: visible; opacity: 1; }
    .dark .modal-content { box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5), 0 10px 10px -5px rgba(0,0,0,0.2); }
    .date-filter-btn.active { background-color: #3b82f6; color: white; }
    .dark .date-filter-btn.active { background-color: #60a5fa; }
    .view-detail-label { font-weight: 500; color: #4b5563; }
    .dark .view-detail-label { color: #d1d5db; }
    .view-detail-value { color: #1f2937; }
    .dark .view-detail-value { color: #f9fafb; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white">

<!-- Main application wrapper -->
<div class="flex h-screen">

    <!-- Sidebar (Left) - Modified for responsiveness -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-white dark:bg-gray-800/95 backdrop-blur-sm p-4 space-y-6 shadow-lg
                             transform -translate-x-full transition-transform duration-300 ease-in-out
                             md:relative md:translate-x-0 md:shadow-lg md:border-r dark:border-gray-700
                             flex flex-col flex-shrink-0">
      <div class="flex justify-between items-center">
        <div class="text-2xl font-bold flex items-center space-x-2 text-primary dark:text-primary-light">
          <i data-lucide="command" class="w-7 h-7"></i><span>FleetDash</span>
        </div>
        <!-- Close button for mobile sidebar -->
        <button id="sidebar-close-button" class="md:hidden text-gray-700 dark:text-gray-300 p-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <nav class="flex-1 overflow-y-auto">
        <ul class="space-y-2">
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="layout-dashboard" class="w-5 h-5"></i><a href="dashboard">Dashboard</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="pie-chart" class="w-5 h-5"></i><a href="analytics">Analytics</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="user" class="w-5 h-5"></i><a href="driver">Driver</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="alert-triangle" class="w-5 h-5"></i><a href="panne">Pannes (Issues)</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="car" class="w-5 h-5"></i><a href="vehicle">Vehicles</a>
            </li>
             <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="wrench" class="w-5 h-5"></i><a href="reparation">Reparation</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="droplet" class="w-5 h-5"></i><a href="fuel">Fuel</a>
            </li>
            <li id="maintenance-nav-link" class="flex items-center space-x-3 text-blue-600 dark:text-blue-400 font-semibold bg-blue-50 dark:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="settings" class="w-5 h-5"></i><a href="maintenance">Maintenance</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="route" class="w-5 h-5"></i><a href="trip">Trip</a>
            </li>
      </ul>
      </nav>
       <div class="pt-4 border-t border-gray-200 dark:border-gray-700/50 mt-auto">
            <a href="#" id="global-logout-btn" class="flex items-center space-x-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/40 p-2.5 rounded-lg transition-colors">
                <i data-lucide="log-out" class="w-5 h-5"></i><span>Logout</span>
            </a>
       </div>
    </aside>

    <!-- Overlay for mobile menu -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

    <!-- Content Area Wrapper (Header + Main Content + Right Sidebar) -->
    <div class="flex-1 flex flex-col overflow-hidden">

      <!-- Header (Mobile Hamburger, Desktop Title, Theme Toggle, User Info) -->
      <header class="bg-white dark:bg-gray-800 shadow p-3 flex justify-between items-center flex-shrink-0 h-16">
          <button id="mobile-menu-button" class="md:hidden text-gray-700 dark:text-gray-300 focus:outline-none p-2">
              <i data-lucide="menu" class="w-6 h-6"></i>
          </button>

          <div class="text-lg font-bold text-primary dark:text-primary-light md:hidden">
              FleetDash
          </div>

          <div class="hidden md:block text-xl font-semibold text-gray-700 dark:text-gray-200">
              Maintenance Management
          </div>

          <div class="flex items-center space-x-3">
              <button id="theme-toggle-header" class="text-xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
              </button>
              <div class="hidden md:flex items-center space-x-2">
                  <div class="text-sm font-semibold" id="userDisplayNameHeader">User</div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">Admin</div>
              </div>
          </div>
      </header>

      <!-- Main scrollable content area (Main Page Content + Right Sidebar) -->
      <div class="flex-1 flex overflow-hidden">
        <main class="flex-1 overflow-y-auto p-6">
          <!-- Maintenance Table Section -->
          <section id="maintenance-section" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
               <div class="flex flex-wrap gap-2 items-center">
                <button id="openAddMaintenanceModalButton" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-1 text-sm shadow-sm">
                  <i data-lucide="plus" class="w-4 h-4"></i> Add Maintenance
                </button>
                <input type="text" id="maintenanceSearch" placeholder="Search (category, vehicle, receipt...)" class="border dark:border-gray-600 rounded-lg px-3 py-2 text-sm text-black dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-auto">
              </div>
              <div class="flex flex-wrap gap-2 items-center">
                <button id="exportExcelButton" class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 text-sm shadow-sm">ðŸ“„ Excel</button>
                <button id="exportPdfButton" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 text-sm shadow-sm">ðŸ§¾ PDF</button>
              </div>
            </div>

            <div class="mb-4 flex flex-wrap items-center gap-2">
              <span class="text-sm font-medium mr-2">Filter Maintenance by Date:</span>
              <button id="maintenance-filter-today" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Today</button>
              <button id="maintenance-filter-last7" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Last 7 Days</button>
              <button id="maintenance-filter-last30" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Last 30 Days</button>
              <button id="maintenance-filter-all" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 active">All Time</button>
              <button id="maintenance-filter-custom-btn" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Custom Range</button>
            </div>
            <div id="maintenanceCustomDateRange" class="mb-4 hidden items-center gap-2 p-3 border dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-800/50">
              <input type="date" id="maintenanceCustomStartDate" class="border dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-black dark:bg-gray-700 dark:text-white">
              <span class="text-sm">to</span>
              <input type="date" id="maintenanceCustomEndDate" class="border dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-black dark:bg-gray-700 dark:text-white">
              <button id="applyCustomDateFilterButton" class="bg-blue-500 text-white px-3 py-1.5 text-sm rounded-md hover:bg-blue-600">Apply</button>
            </div>

            <div class="overflow-x-auto">
              <table id="maintenancesTable" class="w-full text-left text-sm">
                <thead>
                  <tr class="border-b dark:border-gray-700">
                    <th class="py-3 px-2 font-semibold">ID</th>
                    <th class="px-2 font-semibold">Category</th>
                    <th class="px-2 font-semibold">Vehicle (Plate)</th>
                    <th class="px-2 font-semibold">Cost ($)</th>
                    <th class="px-2 font-semibold">Receipt</th>
                    <th class="px-2 font-semibold">Garage</th>
                    <th class="px-2 font-semibold">Status</th>
                    <th class="px-2 font-semibold">Maint. Date</th>
                    <th class="px-2 font-semibold text-center">Actions</th>
                  </tr>
                </thead>
                <tbody id="maintenancesBody"></tbody>
              </table>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
              <div class="text-sm text-gray-600 dark:text-gray-400" id="maintenancesCount"></div>
              <div class="flex items-center space-x-1" id="maintenancesPagination"></div>
            </div>
          </section>
        </main>

        <!-- Right Sidebar -->
        <aside class="w-1/5 bg-white dark:bg-gray-800/95 backdrop-blur-sm p-4 space-y-6 shadow-lg hidden lg:block flex-shrink-0 border-l dark:border-gray-700 overflow-y-auto">
            <div class="flex justify-end items-center">
                <div class="text-right">
                    <div class="text-sm font-semibold text-gray-800 dark:text-white" id="userDisplayNameRightSidebar">User</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Fleet Analyst</div>
                </div>
                <img src="https://i.pravatar.cc/40?u=analyst_jane_doe" alt="Analyst" class="w-10 h-10 rounded-full ml-2 object-cover">
            </div>
            <hr class="dark:border-gray-700/50">
            <div>
                <h4 class="font-semibold mb-3 text-gray-700 dark:text-gray-200">Key Performance Insights</h4>
                <ul id="keyPerformanceInsightsList" class="text-xs space-y-2.5 text-gray-600 dark:text-gray-300">
                    <li class="flex items-start space-x-2"><i data-lucide="loader-2" class="w-4 h-4 text-gray-400 animate-spin mt-0.5 shrink-0"></i><span>Loading insights...</span></li>
                </ul>
            </div>
            <hr class="dark:border-gray-700/50">
            <div>
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-semibold text-gray-700 dark:text-gray-200">Alerts & Notifications</h4>
                    <a href="#" id="viewAllNotificationsLink" class="text-xs text-primary dark:text-primary-light hover:underline">View All (<span id="notificationCount">0</span>)</a>
                </div>
                <div id="notificationsList" class="space-y-3 max-h-40 overflow-y-auto pr-1">
                     <div class="flex items-start space-x-2 p-2.5 bg-gray-100 dark:bg-gray-700/50 rounded-lg"><i data-lucide="loader-2" class="w-5 h-5 text-gray-400 animate-spin mt-0.5 flex-shrink-0"></i><p class="text-xs text-gray-700 dark:text-gray-300">Loading alerts...</p></div>
                </div>
            </div>
        </aside>
      </div>
    </div>
</div>


<!-- Add/Edit Maintenance Modal -->
<div id="addMaintenanceModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h3 class="text-xl font-bold text-gray-800 dark:text-white" id="maintenanceModalTitle">Add New Maintenance</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400">Fill in the maintenance details below</p>
        </div>
        <button id="closeAddMaintenanceModalButtonTop" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <form id="addMaintenanceForm" class="space-y-4">
        <input type="hidden" id="maintenanceId_form">
        <input type="hidden" id="original_status_form">
        <input type="hidden" id="original_vehicle_id_form">
        <div>
          <label for="cat_maintenance_id_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Maintenance Category</label>
          <select id="cat_maintenance_id_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
            <option value="">Loading Categories...</option>
          </select>
        </div>
        <div>
          <label for="vehicle_id_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Vehicle</label>
          <select id="vehicle_id_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
            <option value="">Loading Vehicles...</option>
          </select>
        </div>
        <div>
          <label for="maintenance_cost_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Maintenance Cost ($)</label>
          <input type="number" step="0.01" id="maintenance_cost_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="e.g., 150.75">
        </div>
        <div>
          <label for="maintenance_receipt_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Receipt (e.g., URL or Ref#)</label>
          <input type="text" id="maintenance_receipt_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="Receipt details or link">
        </div>
        <div>
          <label for="maintenance_garage_id_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Garage</label>
          <select id="maintenance_garage_id_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
             <option value="">Loading Garages...</option>
          </select>
        </div>
        <div>
          <label for="maintenance_date_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Maintenance Date</label>
          <input type="date" id="maintenance_date_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
        </div>
        <div>
          <label for="maintenance_status_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
          <select id="maintenance_status_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
            <option value="Active">Active</option>
            <option value="Completed">Completed</option>
          </select>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" id="cancelAddMaintenanceModalButton" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
          <button type="submit" id="maintenanceSubmitButton" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center gap-2">
            <i data-lucide="plus-circle" class="w-4 h-4"></i> Add Maintenance
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- View Maintenance Record Modal -->
<div id="viewMaintenanceModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white">Record Details</h3>
        <button id="closeViewMaintenanceModalButtonTop" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <div id="viewMaintenanceDetails" class="space-y-3 text-sm">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 gap-y-2">
            <span class="view-detail-label sm:col-span-1">Record ID:</span><span id="view-maintenance-id" class="view-detail-value sm:col-span-2"></span>
            <span class="view-detail-label sm:col-span-1">Category:</span><span id="view-maintenance-category" class="view-detail-value sm:col-span-2"></span>
            <span class="view-detail-label sm:col-span-1">Vehicle (Plate):</span><span id="view-maintenance-vehicle" class="view-detail-value sm:col-span-2"></span>
            <span class="view-detail-label sm:col-span-1">Status:</span><span id="view-maintenance-status" class="view-detail-value sm:col-span-2"></span>
            <span class="view-detail-label sm:col-span-1">Cost:</span><span id="view-maintenance-cost" class="view-detail-value sm:col-span-2"></span>
            <span class="view-detail-label sm:col-span-1">Receipt:</span><span id="view-maintenance-receipt" class="view-detail-value sm:col-span-2 break-all"></span>
            <span class="view-detail-label sm:col-span-1">Garage:</span><span id="view-maintenance-garage" class="view-detail-value sm:col-span-2"></span>
            <span class="view-detail-label sm:col-span-1">Maint. Date:</span><span id="view-maintenance-maintenance_date" class="view-detail-value sm:col-span-2"></span>
            <span class="view-detail-label sm:col-span-1">Created At:</span><span id="view-maintenance-created_at" class="view-detail-value sm:col-span-2"></span>
        </div>
      </div>
      <div class="flex justify-end pt-6">
          <button type="button" id="closeViewMaintenanceModalButtonBottom" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Generic Confirmation Modal -->
<div id="genericConfirmModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 id="genericConfirmModalTitle" class="text-xl font-bold text-gray-800 dark:text-white">Confirm Action</h3>
        <button id="closeGenericConfirmModalButtonX" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <p id="genericConfirmModalMessage" class="text-sm text-gray-600 dark:text-gray-400 mb-6">Are you sure?</p>
      <div class="flex justify-end gap-3 pt-4">
        <button id="cancelGenericConfirmModalButton" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
        <button id="genericConfirmModalConfirmBtn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center gap-2">
          Confirm
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Information/Status Modal -->
<div id="infoStatusModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
    <div class="p-6 text-center">
      <div id="infoStatusModalIconContainer" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
      </div>
      <h3 id="infoStatusModalTitle" class="text-lg font-medium text-gray-900 dark:text-white mb-2">Status</h3>
      <div class="mt-2">
        <p id="infoStatusModalMessage" class="text-sm text-gray-500 dark:text-gray-400">Message.</p>
      </div>
      <div class="mt-5 sm:mt-6">
        <button type="button" id="infoStatusModalOkButton" class="inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm">OK</button>
      </div>
    </div>
  </div>
</div>

<script>
  const API_BASE_URL = '';
  const LOGIN_PAGE_URL = '/login';
  const VEHICLE_API_ENDPOINT = '/vehicle/';
  const MAINTENANCE_API_ENDPOINT = '/maintenance/';
  const CAT_MAINTENANCE_API_ENDPOINT = '/category_maintenance/';
  const GARAGE_API_ENDPOINT = '/garage/';

  const VEHICLE_STATUS_IN_MAINTENANCE = 'in_maintenance';
  const VEHICLE_STATUS_AVAILABLE = 'available';

  // --- Authentication Helper ---
  function getAuthToken() { return localStorage.getItem('accessToken'); }
  function parseJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { console.error("JWT Parse Error:", e); return null; }}

  function updateUserInfoDisplay() {
    const token = getAuthToken();
     const userDisplayElements = [
        document.getElementById('userDisplayNameHeader'),
        document.getElementById('userDisplayNameRightSidebar')
    ];

    userDisplayElements.forEach(userDisplayElement => {
        if (!userDisplayElement) return;
        if (token) {
            const decoded = parseJwt(token);
            userDisplayElement.textContent = (decoded && decoded.sub) ? decoded.sub : 'User';
        } else {
            userDisplayElement.textContent = 'Guest';
        }
    });
  }

  async function apiRequest(endpoint, method = 'GET', body = null) {
    const token = getAuthToken();
    const headers = { 'Content-Type': 'application/json' };

    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    } else if (!endpoint.startsWith('/login')) {
        console.warn(`WARN: Protected endpoint ${endpoint} called without token.`);
    }

    const config = { method, headers };
    if (body) config.body = JSON.stringify(body);

    try {
        const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
        const responseHeaders = response.headers;

        if (response.status === 401 && !endpoint.endsWith('/login/')) {
            openInfoStatusModal("Authentication Error", "Session expired or unauthorized. Please log in again.", "error", 5000);
            return null;
        }
        if (response.status === 204) {
            return { data: true, headers: responseHeaders };
        }

        const responseData = await response.json().catch(async () => {
            const text = await response.text();
            console.error(`JSON Parse Error for ${endpoint}. Status: ${response.status}. Response: ${text.substring(0,100)}...`);
            if (!response.ok) return Promise.reject({ detail: text || `Server error ${response.status}` });
            throw new Error(`Invalid JSON response from server (status ${response.status}).`);
        });

        if (!response.ok) {
            const errorDetail = responseData.detail || (typeof responseData === 'object' ? JSON.stringify(responseData) : responseData) || 'Unknown error from server.';
            console.error(`API Error for ${endpoint}: ${response.status}`, errorDetail);
            openInfoStatusModal(`API Error: ${response.status}`, Array.isArray(errorDetail) ? errorDetail.map(e => e.msg).join('; ') : errorDetail, "error");
            return null;
        }
        return { data: responseData, headers: responseHeaders };
    } catch (error) {
      console.error(`Network/Catch Error during API request to ${endpoint}:`, error);
      const errorMessage = error.detail || error.message || "A network or request error occurred.";
      openInfoStatusModal("Request Error", errorMessage, "error");
      return null;
    }
  }

  let allMaintenances = [];
  const maintenancesPerPage = 10;
  let currentMaintenancePage = 1;
  let totalMaintenanceRecords = 0;
  let maintenanceToEditId = null;
  let activeMaintenanceDateFilter = 'all';
  let customMaintenanceFilterStartDate = null;
  let customMaintenanceFilterEndDate = null;
  let allMaintenanceCategories = [];
  let allVehiclesForDropdown = [];
  let allGaragesForDropdown = [];
  let currentConfirmAction = null;
  let currentActionData = null;
  let infoStatusModalTimeout = null;

  // --- Sidebar & Theme ---
  const sidebar = document.getElementById('sidebar'); const mobileMenuButton = document.getElementById('mobile-menu-button'); const sidebarCloseButton = document.getElementById('sidebar-close-button'); const sidebarOverlay = document.getElementById('sidebar-overlay'); const themeToggleButton = document.getElementById('theme-toggle-header'); function openMobileMenu() { if (sidebar && sidebarOverlay) { sidebar.classList.remove('-translate-x-full'); sidebar.classList.add('translate-x-0'); sidebarOverlay.classList.remove('hidden'); document.body.classList.add('overflow-hidden', 'md:overflow-auto'); } } function closeMobileMenu() { if (sidebar && sidebarOverlay) { sidebar.classList.add('-translate-x-full'); sidebar.classList.remove('translate-x-0'); sidebarOverlay.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); } } function setInitialThemeIcon() { if (themeToggleButton) { if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.documentElement.classList.add('dark'); themeToggleButton.innerHTML = '<i data-lucide="sun" class="w-5 h-5"></i>'; } else { document.documentElement.classList.remove('dark'); themeToggleButton.innerHTML = '<i data-lucide="moon" class="w-5 h-5"></i>'; } lucide.createIcons(); } } function toggleTheme() { if (document.documentElement.classList.contains('dark')) { document.documentElement.classList.remove('dark'); localStorage.setItem('theme', 'light'); } else { document.documentElement.classList.add('dark'); localStorage.setItem('theme', 'dark'); } setInitialThemeIcon(); }

  // --- Dashboard Widget Functions ---
  async function fetchAndDisplayPerformanceInsights() {
      const insightsList = document.getElementById('keyPerformanceInsightsList');
      if (!insightsList) return;

      insightsList.innerHTML = `<li class="flex items-start space-x-2"><i data-lucide="loader-2" class="w-4 h-4 text-gray-400 animate-spin mt-0.5 shrink-0"></i><span>Loading insights...</span></li>`;
      lucide.createIcons();

      const result = await apiRequest('/dashboard-data/performance-insights');
      if (!result || !result.data) {
          insightsList.innerHTML = `<li class="flex items-start space-x-2 text-red-500"><i data-lucide="alert-circle" class="w-4 h-4 mt-0.5 shrink-0"></i><span>Failed to load insights.</span></li>`;
          lucide.createIcons();
          return;
      }
      const data = result.data;

      let insightsHTML = '';

      const { fuel_efficiency } = data;
      if (fuel_efficiency) {
          let trendIcon = 'minus';
          let trendColor = 'text-gray-500 dark:text-gray-400';
          let trendText = 'steady';

          if (fuel_efficiency.trend === 'up') {
              trendIcon = 'trending-up';
              trendColor = 'text-green-500';
              trendText = 'improving';
          } else if (fuel_efficiency.trend === 'down') {
              trendIcon = 'trending-down';
              trendColor = 'text-red-500';
              trendText = 'worsening';
          }

          const percentageText = fuel_efficiency.percentage_change !== null
              ? `(${fuel_efficiency.percentage_change > 0 ? '+' : ''}${fuel_efficiency.percentage_change}%)`
              : '(No prior data)';

          insightsHTML += `
              <li class="flex items-start space-x-2">
                  <i data-lucide="droplet" class="w-4 h-4 text-blue-500 mt-0.5 shrink-0"></i>
                  <div>
                      <span>Fuel Efficiency is <span class="${trendColor} font-semibold">${trendText}</span>.</span>
                      <span class="block text-gray-400 dark:text-gray-500 text-xs">Consumption vs last month ${percentageText}.</span>
                  </div>
              </li>`;
      }

      const { maintenance_compliance } = data;
      if (maintenance_compliance) {
          insightsHTML += `
              <li class="flex items-start space-x-2">
                  <i data-lucide="wrench" class="w-4 h-4 text-yellow-500 mt-0.5 shrink-0"></i>
                  <div>
                      <span><span class="font-semibold">${maintenance_compliance.total_maintenance_records}</span> maintenance records logged.</span>
                      <span class="block text-gray-400 dark:text-gray-500 text-xs">Total historical maintenance tasks.</span>
                  </div>
              </li>`;
      }

      insightsList.innerHTML = insightsHTML || `<li>No performance data available.</li>`;
      lucide.createIcons();
  }

  async function fetchAndDisplayAlerts() {
      const alertsList = document.getElementById('notificationsList');
      const notificationCountSpan = document.getElementById('notificationCount');
      if (!alertsList || !notificationCountSpan) return;

      alertsList.innerHTML = `<div class="flex items-start space-x-2 p-2.5 bg-gray-100 dark:bg-gray-700/50 rounded-lg"><i data-lucide="loader-2" class="w-5 h-5 text-gray-400 animate-spin mt-0.5 flex-shrink-0"></i><p class="text-xs text-gray-700 dark:text-gray-300">Loading alerts...</p></div>`;
      lucide.createIcons();

      const result = await apiRequest('/dashboard-data/alerts');
      if (!result || !result.data) {
          alertsList.innerHTML = `<div class="flex items-start space-x-2 text-red-500"><i data-lucide="alert-circle" class="w-4 h-4 mt-0.5 shrink-0"></i><p class="text-xs">Failed to load alerts.</p></div>`;
          notificationCountSpan.textContent = '0';
          lucide.createIcons();
          return;
      }
      const data = result.data;

      notificationCountSpan.textContent = data.total_alerts || '0';
      let alertsHTML = '';

      const createAlertItemHTML = (alert, icon, colorClass) => {
          if (!alert) return '';
          return `
              <div class="flex items-start space-x-2 p-2.5 bg-gray-100 dark:bg-gray-700/50 rounded-lg">
                  <i data-lucide="${icon}" class="w-5 h-5 ${colorClass} mt-0.5 flex-shrink-0"></i>
                  <div>
                      <p class="text-xs font-semibold text-gray-800 dark:text-gray-200">${alert.plate_number}</p>
                      <p class="text-xs text-gray-600 dark:text-gray-300">${alert.message}</p>
                  </div>
              </div>`;
      };

      alertsHTML += createAlertItemHTML(data.critical_panne, 'shield-alert', 'text-red-500');
      alertsHTML += createAlertItemHTML(data.maintenance_alert, 'calendar-clock', 'text-blue-500');
      alertsHTML += createAlertItemHTML(data.trip_alert, 'route', 'text-purple-500');

      if (data.total_alerts === 0) {
          alertsHTML = `<div class="flex items-center justify-center text-center p-4">
                          <div class="text-gray-500 dark:text-gray-400">
                             <i data-lucide="check-circle" class="w-8 h-8 mx-auto mb-2 text-green-500"></i>
                             <p class="text-xs">All clear! No new alerts.</p>
                          </div>
                        </div>`;
      }

      alertsList.innerHTML = alertsHTML;
      lucide.createIcons();
  }

  async function initializeDashboardWidgets() {
      await Promise.all([
          fetchAndDisplayPerformanceInsights(),
          fetchAndDisplayAlerts()
      ]);
  }

  // --- Modal Control ---
  function closeModal(modalId) { document.getElementById(modalId)?.classList.add('hidden'); document.body.style.overflow = ''; }
  function openModal(modalId) { document.getElementById(modalId)?.classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
  function closeAddMaintenanceModal() { closeModal('addMaintenanceModal'); maintenanceToEditId = null; document.getElementById('addMaintenanceForm')?.reset(); document.getElementById('maintenanceSubmitButton').disabled = false; }
  function closeViewMaintenanceModal() { closeModal('viewMaintenanceModal'); }
  function closeGenericConfirmModal() { closeModal('genericConfirmModal'); currentConfirmAction = null; currentActionData = null; }
  function closeInfoStatusModal() { if (infoStatusModalTimeout) { clearTimeout(infoStatusModalTimeout); infoStatusModalTimeout = null; } closeModal('infoStatusModal'); }
  function openGenericConfirmModal(title, message, confirmButtonText, confirmButtonIcon, onConfirmCallback, actionData = null) { document.getElementById('genericConfirmModalTitle').textContent = title; document.getElementById('genericConfirmModalMessage').textContent = message; const confirmBtn = document.getElementById('genericConfirmModalConfirmBtn'); confirmBtn.innerHTML = `<i data-lucide="${confirmButtonIcon || 'check-circle'}" class="w-4 h-4 mr-1"></i> ${confirmButtonText || 'Confirm'}`; confirmBtn.className = `px-4 py-2 text-white rounded-lg flex items-center gap-2 ${ confirmButtonIcon === 'trash-2' ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600' }`; lucide.createIcons(); currentConfirmAction = onConfirmCallback; currentActionData = actionData; openModal('genericConfirmModal'); }
  function openInfoStatusModal(title, message, type = 'success', autoCloseDelay = 4000) { const titleEl = document.getElementById('infoStatusModalTitle'); const messageEl = document.getElementById('infoStatusModalMessage'); const iconContainer = document.getElementById('infoStatusModalIconContainer'); const okButton = document.getElementById('infoStatusModalOkButton'); titleEl.textContent = title; messageEl.textContent = message; if (infoStatusModalTimeout) clearTimeout(infoStatusModalTimeout); let iconName = 'info', iconColorClass = 'text-blue-600', bgColorClass = 'bg-blue-100', btnClass = 'bg-blue-600 hover:bg-blue-700 focus:ring-blue-500'; if (type === 'success') { iconName = 'check-circle-2'; iconColorClass = 'text-green-600'; bgColorClass = 'bg-green-100'; btnClass = 'bg-green-600 hover:bg-green-700 focus:ring-green-500'; } else if (type === 'error') { iconName = 'alert-triangle'; iconColorClass = 'text-red-600'; bgColorClass = 'bg-red-100'; btnClass = 'bg-red-600 hover:bg-red-700 focus:ring-red-500'; } else if (type === 'warning') { iconName = 'alert-octagon'; iconColorClass = 'text-yellow-500'; bgColorClass = 'bg-yellow-100'; btnClass = 'bg-yellow-500 hover:bg-yellow-600 focus:ring-yellow-400'; } iconContainer.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full ${bgColorClass} mb-4`; iconContainer.innerHTML = `<i data-lucide="${iconName}" class="h-6 w-6 ${iconColorClass}"></i>`; okButton.className = `inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white ${btnClass} focus:outline-none focus:ring-2 focus:ring-offset-2 sm:text-sm`; lucide.createIcons(); openModal('infoStatusModal'); if (autoCloseDelay > 0 && type !== 'error') { infoStatusModalTimeout = setTimeout(closeInfoStatusModal, autoCloseDelay); } }

  // --- Event Listeners & Initializers ---
  document.addEventListener('DOMContentLoaded', async () => {
      lucide.createIcons();
      updateUserInfoDisplay();
      setInitialThemeIcon();

      themeToggleButton?.addEventListener('click', toggleTheme);
      mobileMenuButton?.addEventListener('click', openMobileMenu);
      sidebarCloseButton?.addEventListener('click', closeMobileMenu);
      sidebarOverlay?.addEventListener('click', closeMobileMenu);
      document.querySelectorAll('#sidebar nav a').forEach(link => {
          link.addEventListener('click', () => { if (window.innerWidth < 768) closeMobileMenu(); });
      });

      // Modal close events
      ['addMaintenanceModal', 'viewMaintenanceModal', 'genericConfirmModal'].forEach(id => {
          document.getElementById(id)?.addEventListener('click', e => { if (e.target.id === id) closeModal(id); });
      });
      document.getElementById('infoStatusModal')?.addEventListener('click', e => { if (e.target.id === 'infoStatusModal' || e.target.closest('#infoStatusModalOkButton')) closeInfoStatusModal(); });
      document.getElementById('closeAddMaintenanceModalButtonTop')?.addEventListener('click', closeAddMaintenanceModal);
      document.getElementById('cancelAddMaintenanceModalButton')?.addEventListener('click', closeAddMaintenanceModal);
      document.getElementById('closeViewMaintenanceModalButtonTop')?.addEventListener('click', closeViewMaintenanceModal);
      document.getElementById('closeViewMaintenanceModalButtonBottom')?.addEventListener('click', closeViewMaintenanceModal);
      document.getElementById('closeGenericConfirmModalButtonX')?.addEventListener('click', closeGenericConfirmModal);
      document.getElementById('cancelGenericConfirmModalButton')?.addEventListener('click', closeGenericConfirmModal);
      document.getElementById('genericConfirmModalConfirmBtn')?.addEventListener('click', async () => { if (typeof currentConfirmAction === 'function') await currentConfirmAction(currentActionData); closeGenericConfirmModal(); });
      document.getElementById('global-logout-btn')?.addEventListener('click', (e) => { e.preventDefault(); localStorage.removeItem('accessToken'); window.location.href = LOGIN_PAGE_URL; });

      // Page specific events
      document.getElementById('openAddMaintenanceModalButton')?.addEventListener('click', openAddMaintenanceModal);
      document.getElementById('exportExcelButton')?.addEventListener('click', exportMaintenancesExcel);
      document.getElementById('exportPdfButton')?.addEventListener('click', exportMaintenancesPDF);
      document.getElementById('maintenanceSearch').addEventListener('input', () => { currentMaintenancePage = 1; fetchAndRenderMaintenances(); });
      document.getElementById('addMaintenanceForm').addEventListener('submit', handleMaintenanceFormSubmit);

      // Filter events
      document.getElementById('maintenance-filter-today').addEventListener('click', () => applyMaintenanceDateFilter('today'));
      document.getElementById('maintenance-filter-last7').addEventListener('click', () => applyMaintenanceDateFilter('last7days'));
      document.getElementById('maintenance-filter-last30').addEventListener('click', () => applyMaintenanceDateFilter('last30days'));
      document.getElementById('maintenance-filter-all').addEventListener('click', () => applyMaintenanceDateFilter('all'));
      document.getElementById('maintenance-filter-custom-btn').addEventListener('click', toggleMaintenanceCustomDateRange);
      document.getElementById('applyCustomDateFilterButton').addEventListener('click', applyMaintenanceCustomDateFilter);

      await initializeMaintenanceSection();
  });

  async function initializeMaintenanceSection() {
    await populateLookupData();
    await fetchAndRenderMaintenances();
    if (getAuthToken()) {
      await initializeDashboardWidgets();
    }
  }

  async function populateLookupData() {
    const [catResult, vehicleResult, garageResult] = await Promise.all([
      apiRequest(CAT_MAINTENANCE_API_ENDPOINT + '?limit=200'),
      apiRequest(VEHICLE_API_ENDPOINT + '?limit=1000'),
      apiRequest(GARAGE_API_ENDPOINT + '?limit=200')
    ]);
    allMaintenanceCategories = catResult?.data || [];
    allVehiclesForDropdown = vehicleResult?.data || [];
    allGaragesForDropdown = garageResult?.data || [];
  }

  function populateMaintenanceDropdowns() {
    const populate = (selectId, data, valueField, textField, placeholder) => {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = `<option value="">${placeholder}</option>`;
        (data || []).forEach(item => {
            select.add(new Option(item[textField], item[valueField]));
        });
    };
    populate('cat_maintenance_id_form', allMaintenanceCategories, 'id', 'cat_maintenance', 'Select Category');
    populate('vehicle_id_form', allVehiclesForDropdown, 'id', 'plate_number', 'Select Vehicle');
    populate('maintenance_garage_id_form', allGaragesForDropdown, 'id', 'nom_garage', 'Select Garage');
  }

  // --- Filtering and Rendering ---
  function applyMaintenanceDateFilter(filterType) {
    activeMaintenanceDateFilter = filterType;
    document.getElementById('maintenanceCustomDateRange').classList.add('hidden');
    setActiveMaintenanceDateFilterButton(filterType);
    currentMaintenancePage = 1;
    fetchAndRenderMaintenances();
  }
  function toggleMaintenanceCustomDateRange() {
    document.getElementById('maintenanceCustomDateRange').classList.toggle('hidden');
    if (!document.getElementById('maintenanceCustomDateRange').classList.contains('hidden')) {
      setActiveMaintenanceDateFilterButton('maintenance-filter-custom-btn');
    }
  }
  function applyMaintenanceCustomDateFilter() {
    customMaintenanceFilterStartDate = document.getElementById('maintenanceCustomStartDate').value;
    customMaintenanceFilterEndDate = document.getElementById('maintenanceCustomEndDate').value;
    activeMaintenanceDateFilter = 'custom';
    currentMaintenancePage = 1;
    fetchAndRenderMaintenances();
  }
  function setActiveMaintenanceDateFilterButton(filterId) {
    document.querySelectorAll('#maintenance-section .date-filter-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`maintenance-filter-${filterId.replace('maintenance-filter-', '')}`).classList.add('active');
  }

  async function fetchAndRenderMaintenances() {
    if (!getAuthToken()) {
        document.getElementById('maintenancesBody').innerHTML = `<tr><td colspan="9" class="text-center py-8 text-red-500">Please log in to view maintenance records.</td></tr>`;
        return;
    }

    let queryParams = `limit=${maintenancesPerPage}&skip=${(currentMaintenancePage - 1) * maintenancesPerPage}`;
    const searchTerm = document.getElementById('maintenanceSearch').value;
    if (searchTerm) queryParams += `&search=${encodeURIComponent(searchTerm)}`;

    if (activeMaintenanceDateFilter !== 'all') {
      const range = (activeMaintenanceDateFilter === 'custom')
        ? { startDate: customMaintenanceFilterStartDate, endDate: customMaintenanceFilterEndDate }
        : getDateRange(activeMaintenanceDateFilter);
      if (range.startDate && range.endDate) {
        queryParams += `&start_date=${range.startDate}&end_date=${range.endDate}`;
      }
    }

    const apiResult = await apiRequest(`${MAINTENANCE_API_ENDPOINT}?${queryParams}`);
    if (!apiResult) {
        allMaintenances = [];
        renderMaintenancesTable(0);
        return;
    }

    const { data, headers } = apiResult;
    allMaintenances = Array.isArray(data) ? data : [];
    totalMaintenanceRecords = parseInt(headers.get('X-Total-Count') || allMaintenances.length, 10);
    renderMaintenancesTable();
  }

  function renderMaintenancesTable() {
    const maintenancesBody = document.getElementById('maintenancesBody');
    maintenancesBody.innerHTML = allMaintenances.length > 0 ? allMaintenances.map(m => {
      const isCompleted = m.status === 'Completed';
      const category = allMaintenanceCategories.find(c => c.id === m.cat_maintenance_id);
      const vehicle = allVehiclesForDropdown.find(v => v.id === m.vehicle_id);
      const garage = allGaragesForDropdown.find(g => g.id === m.garage_id);

      const statusColor = isCompleted ? "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200" : "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200";

      return `<tr class="border-b dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                <td class="py-3 px-2">${m.id}</td>
                <td class="px-2">${category?.cat_maintenance || 'N/A'}</td>
                <td class="px-2">${vehicle?.plate_number || 'N/A'}</td>
                <td class="px-2 text-right">${parseFloat(m.maintenance_cost).toFixed(2)}</td>
                <td class="px-2 truncate max-w-[100px]">${m.receipt || 'N/A'}</td>
                <td class="px-2">${garage?.nom_garage || 'N/A'}</td>
                <td class="px-2"><span class="px-2 py-1 text-xs font-medium rounded-full ${statusColor}">${m.status}</span></td>
                <td class="px-2">${new Date(m.maintenance_date).toLocaleDateString()}</td>
                <td class="px-2 text-center whitespace-nowrap">
                  <button onclick="openViewMaintenanceModal(${m.id})" class="text-green-600 dark:text-green-400 p-1" title="View"><i data-lucide="eye" class="w-4 h-4"></i></button>
                  <button onclick="openEditMaintenanceModal(${m.id})" class="text-blue-600 dark:text-blue-400 p-1 ml-1" title="Edit" ${isCompleted ? 'disabled' : ''}><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                  <button onclick="openConfirmDeleteMaintenanceModal(${m.id})" class="text-red-600 dark:text-red-400 p-1 ml-1" title="Delete" ${isCompleted ? 'disabled' : ''}><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </td></tr>`;
    }).join('') : `<tr><td colspan="9" class="text-center py-8 text-gray-500">No maintenance records found.</td></tr>`;
    lucide.createIcons();

    const startRecord = allMaintenances.length > 0 ? (currentMaintenancePage - 1) * maintenancesPerPage + 1 : 0;
    const endRecord = startRecord + allMaintenances.length - 1;
    document.getElementById('maintenancesCount').textContent = `Showing ${startRecord} to ${endRecord} of ${totalMaintenanceRecords} records`;
    renderMaintenancePagination(totalMaintenanceRecords);
  }

  function renderMaintenancePagination(totalRecords) {
    const totalPages = Math.ceil(totalRecords / maintenancesPerPage);
    const paginationContainer = document.getElementById('maintenancesPagination');
    paginationContainer.innerHTML = '';

    if (totalPages <= 1) return;

    const buttonClasses = "px-3 py-1.5 text-sm rounded-md transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-offset-1 dark:focus:ring-offset-gray-900 focus:ring-blue-500";
    const inactiveClasses = "bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700";
    const disabledClasses = "bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-400 dark:text-gray-500 cursor-not-allowed";

    const prevButton = document.createElement('button');
    prevButton.innerHTML = `<i data-lucide="chevron-left" class="w-4 h-4 inline-block mr-1"></i> Prev`;
    prevButton.className = `${buttonClasses} ${currentMaintenancePage === 1 ? disabledClasses : inactiveClasses}`;
    if (currentMaintenancePage > 1) {
        prevButton.onclick = () => { currentMaintenancePage--; fetchAndRenderMaintenances(); };
    } else { prevButton.disabled = true; }
    paginationContainer.appendChild(prevButton);

    const pageInfo = document.createElement('span');
    pageInfo.className = "px-3 py-1.5 text-sm text-gray-500 dark:text-gray-400";
    pageInfo.textContent = `Page ${currentMaintenancePage} of ${totalPages}`;
    paginationContainer.appendChild(pageInfo);

    const nextButton = document.createElement('button');
    nextButton.innerHTML = `Next <i data-lucide="chevron-right" class="w-4 h-4 inline-block ml-1"></i>`;
    const hasMore = currentMaintenancePage < totalPages;
    nextButton.className = `${buttonClasses} ${!hasMore ? disabledClasses : inactiveClasses}`;
    if (hasMore) {
        nextButton.onclick = () => { currentMaintenancePage++; fetchAndRenderMaintenances(); };
    } else { nextButton.disabled = true; }
    paginationContainer.appendChild(nextButton);

    lucide.createIcons();
  }

  // --- Helper Functions ---
  function getISODateString(date) {
    if (!(date instanceof Date) || isNaN(date)) return '';
    const tzoffset = (new Date()).getTimezoneOffset() * 60000;
    const localISOTime = (new Date(date - tzoffset)).toISOString().slice(0, -1);
    return localISOTime.split('T')[0];
  }

  function getDateRange(filterType) {
    const today = new Date(); today.setHours(0,0,0,0);
    let startDate = new Date(today);
    let endDate = new Date(today);
    endDate.setHours(23,59,59,999);
    switch(filterType) {
        case 'today': break;
        case 'last7days': startDate.setDate(today.getDate() - 6); break;
        case 'last30days': startDate.setDate(today.getDate() - 29); break;
        default: return { startDate: null, endDate: null };
    }
    return { startDate: getISODateString(startDate), endDate: getISODateString(endDate) };
  }

  // --- Modal Operations ---
  async function openAddMaintenanceModal() {
    if (!getAuthToken()) { openInfoStatusModal("Authentication Required", "Please log in.", "error"); return; }
    maintenanceToEditId = null;
    document.getElementById('addMaintenanceForm').reset();
    document.getElementById('maintenanceModalTitle').textContent = "Add New Maintenance";
    document.getElementById('maintenanceSubmitButton').innerHTML = `<i data-lucide="plus-circle" class="w-4 h-4 mr-1"></i> Add Record`;

    const populate = (selectId, data, valueField, textField, placeholder) => {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = `<option value="">${placeholder}</option>`;
        (data || []).forEach(item => {
            select.add(new Option(item[textField], item[valueField]));
        });
    };

    populate('cat_maintenance_id_form', allMaintenanceCategories, 'id', 'cat_maintenance', 'Select Category');
    populate('maintenance_garage_id_form', allGaragesForDropdown, 'id', 'nom_garage', 'Select Garage');

    const vehicleSelect = document.getElementById('vehicle_id_form');
    const availableVehicles = allVehiclesForDropdown.filter(v => v.status === VEHICLE_STATUS_AVAILABLE);

    if (availableVehicles.length > 0) {
        populate('vehicle_id_form', availableVehicles, 'id', 'plate_number', 'Select an Available Vehicle');
    } else {
        vehicleSelect.innerHTML = `<option value="">No available vehicles found</option>`;
    }

    document.getElementById('maintenance_date_form').value = getISODateString(new Date());
    document.getElementById('maintenance_status_form').value = 'Active';
    document.getElementById('maintenance_status_form').disabled = true;
    document.getElementById('vehicle_id_form').disabled = false;

    openModal('addMaintenanceModal');
    lucide.createIcons();
  }

  async function openEditMaintenanceModal(id) {
    if (!getAuthToken()) { openInfoStatusModal("Authentication Required","Please log in.", "error"); return; }

    const apiResult = await apiRequest(`${MAINTENANCE_API_ENDPOINT}${id}`);
    if (!apiResult || !apiResult.data) { openInfoStatusModal("Error","Could not fetch record.", "error"); return; }
    const m = apiResult.data;

    maintenanceToEditId = id;
    populateMaintenanceDropdowns();

    document.getElementById('maintenanceModalTitle').textContent = "Edit Maintenance Record";
    document.getElementById('maintenanceSubmitButton').innerHTML = `<i data-lucide="save" class="w-4 h-4 mr-1"></i> Save Changes`;

    document.getElementById('maintenanceId_form').value = m.id;
    document.getElementById('original_status_form').value = m.status;
    document.getElementById('original_vehicle_id_form').value = m.vehicle_id;
    document.getElementById('cat_maintenance_id_form').value = m.cat_maintenance_id;
    document.getElementById('vehicle_id_form').value = m.vehicle_id;
    document.getElementById('vehicle_id_form').disabled = true;
    document.getElementById('maintenance_cost_form').value = m.maintenance_cost;
    document.getElementById('maintenance_receipt_form').value = m.receipt;
    document.getElementById('maintenance_garage_id_form').value = m.garage_id;
    document.getElementById('maintenance_date_form').value = getISODateString(new Date(m.maintenance_date));
    document.getElementById('maintenance_status_form').value = m.status;
    document.getElementById('maintenance_status_form').disabled = false;

    openModal('addMaintenanceModal');
    lucide.createIcons();
  }

  async function openViewMaintenanceModal(id) {
      const { data: m } = await apiRequest(`${MAINTENANCE_API_ENDPOINT}${id}`);
      if (!m) { openInfoStatusModal("Error", "Could not fetch record details.", "error"); return; }

      const category = allMaintenanceCategories.find(c => c.id === m.cat_maintenance_id);
      const vehicle = allVehiclesForDropdown.find(v => v.id === m.vehicle_id);
      const garage = allGaragesForDropdown.find(g => g.id === m.garage_id);

      document.getElementById('view-maintenance-id').textContent = m.id;
      document.getElementById('view-maintenance-category').textContent = category?.cat_maintenance || 'N/A';
      document.getElementById('view-maintenance-vehicle').textContent = vehicle?.plate_number || 'N/A';
      document.getElementById('view-maintenance-status').textContent = m.status;
      document.getElementById('view-maintenance-cost').textContent = `$${parseFloat(m.maintenance_cost).toFixed(2)}`;
      document.getElementById('view-maintenance-receipt').textContent = m.receipt || 'N/A';
      document.getElementById('view-maintenance-garage').textContent = garage?.nom_garage || 'N/A';
      document.getElementById('view-maintenance-maintenance_date').textContent = new Date(m.maintenance_date).toLocaleDateString();
      document.getElementById('view-maintenance-created_at').textContent = new Date(m.created_at).toLocaleString();

      openModal('viewMaintenanceModal');
  }

  async function handleVehicleStatusUpdate(vehicleId, newStatus) {
    try {
        const result = await apiRequest(`${VEHICLE_API_ENDPOINT}${vehicleId}/status`, 'PATCH', { status: newStatus });
        return result;
    } catch (error) {
        console.error(`Failed to update vehicle ${vehicleId} status to ${newStatus}:`, error);
        openInfoStatusModal("Error", `Failed to update vehicle status for Vehicle ID ${vehicleId}.`, "error");
        return null;
    }
  }

  async function handleMaintenanceFormSubmit(event) {
    event.preventDefault();
    const submitButton = document.getElementById('maintenanceSubmitButton');
    submitButton.disabled = true;

    const formData = {
      cat_maintenance_id: parseInt(document.getElementById('cat_maintenance_id_form').value),
      vehicle_id: parseInt(document.getElementById('vehicle_id_form').value),
      maintenance_cost: parseFloat(document.getElementById('maintenance_cost_form').value),
      receipt: document.getElementById('maintenance_receipt_form').value.trim(),
      garage_id: parseInt(document.getElementById('maintenance_garage_id_form').value),
      maintenance_date: new Date(document.getElementById('maintenance_date_form').value).toISOString(),
      status: document.getElementById('maintenance_status_form').value,
    };

    if (maintenanceToEditId) { // --- UPDATE LOGIC ---
        const originalStatus = document.getElementById('original_status_form').value;
        const vehicleId = formData.vehicle_id; // Vehicle ID cannot be changed in the edit form.

        const result = await apiRequest(`${MAINTENANCE_API_ENDPOINT}${maintenanceToEditId}`, 'PUT', formData);

        if (result) {
            let infoMessage = "Maintenance record updated successfully!";
            let vehicleStatusUpdated = false;

            if (formData.status !== originalStatus) {
                if (formData.status === 'Completed' && originalStatus === 'Active') {
                    await handleVehicleStatusUpdate(vehicleId, VEHICLE_STATUS_AVAILABLE);
                    infoMessage = "Record updated. Vehicle is now available.";
                    vehicleStatusUpdated = true;
                } else if (formData.status === 'Active' && originalStatus !== 'Active') {
                    await handleVehicleStatusUpdate(vehicleId, VEHICLE_STATUS_IN_MAINTENANCE);
                    infoMessage = "Record updated. Vehicle is now in maintenance.";
                    vehicleStatusUpdated = true;
                }
            }

            openInfoStatusModal("Success", infoMessage, "success");
            closeAddMaintenanceModal();
            await fetchAndRenderMaintenances();
            if (vehicleStatusUpdated) {
                await populateLookupData();
            }
        }
    } else { // --- CREATE LOGIC ---
        formData.status = 'Active';
        const result = await apiRequest(MAINTENANCE_API_ENDPOINT, 'POST', formData);
        if (result) {
            await handleVehicleStatusUpdate(formData.vehicle_id, VEHICLE_STATUS_IN_MAINTENANCE);
            openInfoStatusModal("Success", "Maintenance record added. Vehicle status updated to 'In Maintenance'.", "success");
            closeAddMaintenanceModal();
            await fetchAndRenderMaintenances();
            await populateLookupData();
        }
    }
    submitButton.disabled = false;
  }

  function openConfirmDeleteMaintenanceModal(id) {
    openGenericConfirmModal("Confirm Deletion", `Are you sure you want to delete maintenance record ID: ${id}? This will not change the vehicle's status.`, "Delete", "trash-2",
      async (recordId) => {
        const result = await apiRequest(`${MAINTENANCE_API_ENDPOINT}${recordId}`, 'DELETE');
        if (result) {
          openInfoStatusModal("Success", `Maintenance record ${recordId} deleted.`, "success");
          fetchAndRenderMaintenances();
        }
      }, id);
  }

  // --- Export Functions ---
  async function getFullFilteredDataForExport() {
      let queryParams = `limit=1000`; // Fetch a large number for export
      const searchTerm = document.getElementById('maintenanceSearch').value;
      if (searchTerm) queryParams += `&search=${encodeURIComponent(searchTerm)}`;
      if (activeMaintenanceDateFilter !== 'all') {
        const range = (activeMaintenanceDateFilter === 'custom')
          ? { startDate: customMaintenanceFilterStartDate, endDate: customMaintenanceFilterEndDate }
          : getDateRange(activeMaintenanceDateFilter);
        if (range.startDate && range.endDate) {
          queryParams += `&start_date=${range.startDate}&end_date=${range.endDate}`;
        }
      }
      const result = await apiRequest(`${MAINTENANCE_API_ENDPOINT}?${queryParams}`);
      return result?.data || [];
  }

  async function exportMaintenancesExcel() {
    const records = await getFullFilteredDataForExport();
    if (!records || records.length === 0) { openInfoStatusModal("Info", "No data to export based on current filters.", "info"); return; }

    const data = records.map(m => {
        const category = allMaintenanceCategories.find(c => c.id === m.cat_maintenance_id);
        const vehicle = allVehiclesForDropdown.find(v => v.id === m.vehicle_id);
        const garage = allGaragesForDropdown.find(g => g.id === m.garage_id);
        return {
            'ID': m.id,
            'Category': category?.cat_maintenance || 'N/A',
            'Vehicle (Plate)': vehicle?.plate_number || 'N/A',
            'Status': m.status,
            'Cost ($)': parseFloat(m.maintenance_cost).toFixed(2),
            'Receipt': m.receipt,
            'Garage': garage?.nom_garage || 'N/A',
            'Maintenance Date': new Date(m.maintenance_date).toLocaleDateString(),
        };
    });

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Maintenances");
    XLSX.writeFile(wb, "maintenances_export.xlsx");
    openInfoStatusModal("Success", "Data exported to Excel.", "success");
  }

  async function exportMaintenancesPDF() {
    const records = await getFullFilteredDataForExport();
    if (!records || records.length === 0) { openInfoStatusModal("Info", "No data to export based on current filters.", "info"); return; }
    const {jsPDF} = window.jspdf; const doc = new jsPDF('l');
    doc.setFontSize(18); doc.text('Maintenance Records', 14, 15);
    const headers = [['ID', 'Category', 'Vehicle', 'Status', 'Cost ($)', 'Garage', 'Maint. Date']];

    const data = records.map(m => {
        const category = allMaintenanceCategories.find(c => c.id === m.cat_maintenance_id);
        const vehicle = allVehiclesForDropdown.find(v => v.id === m.vehicle_id);
        const garage = allGaragesForDropdown.find(g => g.id === m.garage_id);
        return [
            m.id,
            category?.cat_maintenance || 'N/A',
            vehicle?.plate_number || 'N/A',
            m.status,
            parseFloat(m.maintenance_cost).toFixed(2),
            garage?.nom_garage || 'N/A',
            new Date(m.maintenance_date).toLocaleDateString()
        ];
    });

    doc.autoTable({ head: headers, body: data, startY: 25, theme:'grid', headStyles:{fillColor:[59,130,246],textColor:255},
                    columnStyles: { 4:{halign:'right'}} });
    doc.save('maintenances_export.pdf');
    openInfoStatusModal("Success", "Data exported to PDF.", "success");
  }

</script>
<script src="/static/js/global.js"></script>
</body>
</html>